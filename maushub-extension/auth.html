<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ChromeÊã°ÂºµË™çË®º</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 400px;
                margin: 50px auto;
                padding: 20px;
                text-align: center;
            }
            .auth-container {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 30px;
                background: #f9f9f9;
            }
            .google-btn {
                background: #4285f4;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 20px 0;
            }
            .google-btn:hover {
                background: #357ae8;
            }
            .status {
                margin: 20px 0;
                padding: 10px;
                border-radius: 4px;
            }
            .success {
                background: #d4edda;
                color: #155724;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
            }
        </style>
    </head>
    <body>
        <div class="auth-container">
            <h2>üîê ChromeÊã°ÂºµË™çË®º</h2>
            <p>Ë®±ÂèØ„Åï„Çå„ÅüGoogle„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>

            <button id="googleLogin" class="google-btn">üîç Google„Åß„É≠„Ç∞„Ç§„É≥</button>

            <div id="status"></div>
        </div>

        <!-- Firebase SDK -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
            import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            // FirebaseË®≠ÂÆöÔºàÂÆüÈöõ„ÅÆÂÄ§„Å´ÁΩÆ„ÅçÊèõ„ÅàÔºâ
            const firebaseConfig = {
                apiKey: "AIzaSyA6JMxn_fGeTEasYUeNtgtIMF-wUJ9JPa8",
                authDomain: "sample-9dde3.firebaseapp.com",
                projectId: "sample-9dde3",
                storageBucket: "sample-9dde3.firebasestorage.app",
                messagingSenderId: "434283491779",
                appId: "1:434283491779:web:56a18cfeb70f89e2a2cd76",
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const provider = new GoogleAuthProvider();

            // Ë®±ÂèØ„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            async function isEmailAllowed(email) {
                try {
                    const docRef = doc(db, "config", "allowedUsers");
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists() && docSnap.data().enabled) {
                        const allowedEmails = docSnap.data().emails || [];
                        return allowedEmails.includes(email);
                    }
                    return false;
                } catch (error) {
                    console.error("Error checking allowed users:", error);
                    return false;
                }
            }

            // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
            function showStatus(message, isError = false) {
                const status = document.getElementById("status");
                status.textContent = message;
                status.className = `status ${isError ? "error" : "success"}`;
            }

            // Google„É≠„Ç∞„Ç§„É≥
            document.getElementById("googleLogin").addEventListener("click", async () => {
                try {
                    showStatus("Ë™çË®º‰∏≠...", false);

                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;

                    if (!user.email) {
                        throw new Error("„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü");
                    }

                    // Ë®±ÂèØ„É¶„Éº„Ç∂„Éº„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!(await isEmailAllowed(user.email))) {
                        await auth.signOut();
                        throw new Error("„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                    }

                    // ÊàêÂäüÊôÇÔºöË™çË®ºÊÉÖÂ†±„Çí‰∏ÄÊôÇ‰øùÂ≠ò
                    showStatus("Ë™çË®ºÊàêÂäüÔºÅÊã°ÂºµÊ©üËÉΩ„Å´Êàª„Çä„Åæ„Åô...", false);

                    const userProfile = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split("@")[0],
                        photoURL: user.photoURL,
                        createdAt: Date.now(),
                        lastLoginAt: Date.now(),
                    };

                    console.log("Saving auth data temporarily:", userProfile);

                    // postMessage„Åß„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çπ„ÇØ„É™„Éó„Éà„Å´Ë™çË®ºÊÉÖÂ†±„ÇíÈÄÅ‰ø°
                    try {
                        window.postMessage(
                            {
                                type: "AUTH_SUCCESS",
                                user: userProfile,
                            },
                            window.location.origin
                        );
                        console.log("Auth message posted to content script");

                        // URL„Å´ÊàêÂäü„Éï„É©„Ç∞„ÇíËøΩÂä†„Åó„Å¶„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞
                        const url = new URL(window.location.href);
                        url.searchParams.set("authSuccess", "true");
                        url.searchParams.set("timestamp", Date.now().toString());

                        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å¶„Åã„Çâ„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                        setTimeout(() => {
                            window.location.href = url.toString();
                        }, 1000);
                    } catch (error) {
                        console.error("Error saving auth data:", error);
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÁõ¥Êé•„Çø„Éñ„ÇíÈñâ„Åò„Çã
                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    }

                    // 5ÁßíÂæå„Å´„Çø„Éñ„ÇíÈñâ„Åò„ÇãÔºà„É°„ÉÉ„Çª„Éº„Ç∏Âá¶ÁêÜ„ÅÆÊôÇÈñì„ÇíÁ¢∫‰øùÔºâ
                    setTimeout(() => {
                        console.log("Closing auth tab");
                        window.close();
                    }, 5000);
                } catch (error) {
                    console.error("Ë™çË®º„Ç®„É©„Éº:", error);
                    showStatus(`„Ç®„É©„Éº: ${error.message}`, true);

                    // ChromeÊã°Âºµ„Å´„Ç®„É©„Éº„ÇíÈÄÅ‰ø°
                    if (window.chrome && chrome.runtime) {
                        chrome.runtime.sendMessage(chrome.runtime.id, {
                            type: "AUTH_ERROR",
                            error: error.message,
                        });
                    }
                }
            });

            // URL„Éë„É©„É°„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØ
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get("extension") === "true") {
                document.body.style.background = "#e3f2fd";
                showStatus("ChromeÊã°Âºµ„Åã„Çâ„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü", false);
            }

            // Ë™çË®ºÊàêÂäüÂæå„ÅÆÂá¶ÁêÜ
            if (urlParams.get("authSuccess") === "true") {
                showStatus("Ë™çË®º„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„Çø„Éñ„ÇíÈñâ„Åò„Åæ„Åô...", false);
                console.log("Auth success detected, closing tab");

                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„Çø„Éñ„ÇíÈñâ„Åò„Çã
                setTimeout(() => {
                    window.close();
                }, 2000);
            }
        </script>
    </body>
</html>
